<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Camera mobile</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #0c1010;
      color: #ffffff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .room-mobile {
      width: 100%;
      box-sizing: border-box;
    }

    .room-header-img {
      width: 100%;
      aspect-ratio: 4 / 3;
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      position: relative;
      background-color: #202525;
    }

    .room-header-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.25),
        rgba(0,0,0,0.55)
      );
    }

    .room-content {
      padding: 16px 14px 10px;
    }

    .room-title {
      font-size: 22px;
      margin: 0 0 4px;
    }

    .room-subtitle {
      font-size: 14px;
      opacity: 0.9;
      margin: 0 0 10px;
    }

    .room-badges {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      font-size: 12px;
    }

    .badge-icon {
      font-size: 14px;
    }

    .room-desc {
      font-size: 14px;
      line-height: 1.6;
      margin: 0 0 8px;
    }

    .room-desc-short {
      opacity: 0.9;
    }

    .room-desc-full {
      opacity: 0.95;
    }

    .room-button,
    .room-load-more,
    .room-close,
    .room-next {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: #2d4f4f;
      color: #ffffff;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      margin-top: 6px;
    }

    .room-button:active,
    .room-load-more:active,
    .room-close:active,
    .room-next:active {
      transform: scale(0.97);
    }

    .room-gallery-wrapper {
      padding: 8px 0 16px;
    }

    .room-gallery-column {
      width: 100%;
      box-sizing: border-box;
      padding: 0 14px 8px;
    }

    .room-gallery-column img {
      width: 100%;
      display: block;
      margin: 0 0 8px;
      object-fit: cover;
      border-radius: 4px;
    }

    .room-load-more {
      width: calc(100% - 28px);
      margin: 4px 14px 0;
      background: #404f4f;
    }

    .room-gallery-actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 14px 0;
    }

    .room-close {
      background: #444;
    }

    .room-next {
      background: #607d8b;
    }

    .room-skeleton-note {
      font-size: 12px;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    (function () {
      const API_META  = "https://xbut-eryu-hhsg.f2.xano.io/api:X1XvnYjh/camera_cascina";
      const API_FOTOS = "https://xbut-eryu-hhsg.f2.xano.io/api:X1XvnYjh/Cascina";

      const params = new URLSearchParams(window.location.search);
      const roomNameParam = (params.get("Name") || params.get("name") || "Libri").toLowerCase();
      const nextUrlParam  = params.get("next") || "";
      const defaultBeds   = parseInt(params.get("beds") || "2", 10);

      const app = document.getElementById("app");
      if (!app) return;

      app.innerHTML = `
        <div class="room-mobile">
          <div class="room-header-img">
            <div class="room-header-overlay"></div>
          </div>

          <div class="room-content">
            <h2 class="room-title">Caricamento stanza‚Ä¶</h2>
            <h3 class="room-subtitle" style="display:none;"></h3>

            <div class="room-badges">
              <div class="badge">
                <span class="badge-icon">üõè</span>
                <span>${defaultBeds} ospiti</span>
              </div>
              <div class="badge" data-badge-m2 style="display:none;">
                <span class="badge-icon">„é°</span>
                <span class="badge-m2-text"></span>
              </div>
            </div>

            <p class="room-desc room-desc-short room-skeleton-note">
              Stiamo caricando la descrizione e le foto da Xano‚Ä¶
            </p>
            <div class="room-desc room-desc-full" hidden></div>

            <button class="room-button room-see-more" disabled>
              Scopri di pi√π
            </button>
          </div>

          <div class="room-gallery-wrapper" hidden>
            <div class="room-gallery-column" id="room-gallery-column"></div>
            <button class="room-load-more" hidden>Mostra altre foto</button>
            <div class="room-gallery-actions">
              <button class="room-close">Chiudi stanza</button>
              <a class="room-next" target="_top"${nextUrlParam ? ` href="${nextUrlParam}"` : ' style="display:none;"'}>
                Stanza successiva ‚Üí
              </a>
            </div>
          </div>
        </div>
      `;

      const header        = app.querySelector(".room-header-img");
      const titleEl       = app.querySelector(".room-title");
      const subEl         = app.querySelector(".room-subtitle");
      const badgeM2       = app.querySelector("[data-badge-m2]");
      const badgeM2Text   = app.querySelector(".badge-m2-text");
      const descShortEl   = app.querySelector(".room-desc-short");
      const descFullEl    = app.querySelector(".room-desc-full");
      const btnSeeMore    = app.querySelector(".room-see-more");
      const galleryWrap   = app.querySelector(".room-gallery-wrapper");
      const galleryCol    = app.querySelector("#room-gallery-column");
      const btnLoadMore   = app.querySelector(".room-load-more");
      const btnClose      = app.querySelector(".room-close");

      let allUrls = [];
      let loadedCount = 0;
      const INITIAL_BATCH = 4;
      let stanzaLabel = roomNameParam;

      function appendImages(fromIndex, toIndex) {
        for (let i = fromIndex; i < toIndex && i < allUrls.length; i++) {
          const url = allUrls[i];
          const img = document.createElement("img");
          img.src = url;
          img.alt = stanzaLabel + " " + (i + 1);
          img.loading = "lazy";
          galleryCol.appendChild(img);
          loadedCount++;
        }
      }

      function ensureSeeMoreEnabled() {
        if (btnSeeMore) {
          btnSeeMore.disabled = false;
        }
      }

      /* 1) Meta stanza */
      fetch(API_META, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ Name: roomNameParam })
      })
        .then(res => res.json())
        .then(data => {
          const info = Array.isArray(data) ? data[0] : data;
          if (!info || !info.Name) {
            titleEl.textContent = "Camera non trovata";
            descShortEl.textContent = "Controlla che Name in Xano corrisponda al parametro ?Name nella URL.";
            return;
          }

          stanzaLabel = info.Name;

          const title       = info.Title || info.Name || "Camera";
          const subtitle    = info.Subtitle || "";
          const meters      = info.Meters || null;
          const description = info.Description || "";
          const headUrl     = info.Head && info.Head.url ? info.Head.url : null;

          const shortDesc = description.length > 180
            ? description.slice(0, 180).trim() + "‚Ä¶"
            : description;

          titleEl.textContent = title;

          if (subtitle) {
            subEl.textContent = subtitle;
            subEl.style.display = "";
          }

          if (meters && badgeM2 && badgeM2Text) {
            badgeM2Text.textContent = meters + " m¬≤";
            badgeM2.style.display = "inline-flex";
          }

          descShortEl.classList.remove("room-skeleton-note");
          descShortEl.textContent = shortDesc;
          descFullEl.textContent  = description;

          if (headUrl) {
            header.style.backgroundImage = "url('" + headUrl + "')";
          }

          ensureSeeMoreEnabled();
        })
        .catch(err => {
          console.error("Errore meta camera:", err);
          titleEl.textContent = "Errore nel caricamento";
          descShortEl.textContent = "Non riusciamo a recuperare i dati della stanza da Xano.";
        });

      /* 2) Galleria */
      function loadImages() {
        if (allUrls.length) {
          const nextIndex = loadedCount;
          appendImages(nextIndex, nextIndex + INITIAL_BATCH);
          if (btnLoadMore) {
            btnLoadMore.hidden = loadedCount >= allUrls.length;
          }
          galleryWrap.hidden = false;
          return;
        }

        fetch(API_FOTOS, { cache: "no-store" })
          .then(res => res.json())
          .then(data => {
            if (!Array.isArray(data)) return;

            allUrls = data
              .filter(r =>
                r.Stanza &&
                r.Picture &&
                r.Picture.url &&
                r.Stanza.toLowerCase() === stanzaLabel.toLowerCase()
              )
              .map(r => r.Picture.url);

            if (!allUrls.length) {
              console.warn("Nessuna immagine per stanza:", stanzaLabel);
              return;
            }

            appendImages(0, INITIAL_BATCH);
            if (btnLoadMore) {
              btnLoadMore.hidden = loadedCount >= allUrls.length;
            }
            galleryWrap.hidden = false;
          })
          .catch(err => {
            console.error("Errore caricando immagini:", err);
          });
      }

      if (btnSeeMore) {
        btnSeeMore.addEventListener("click", () => {
          descShortEl.hidden = true;
          descFullEl.hidden  = false;

          loadImages();

          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      }

      if (btnLoadMore) {
        btnLoadMore.addEventListener("click", () => {
          loadImages();
        });
      }

      if (btnClose) {
        btnClose.addEventListener("click", () => {
          descShortEl.hidden = false;
          descFullEl.hidden  = true;

          galleryWrap.hidden = true;
          galleryCol.innerHTML = "";
          allUrls = [];
          loadedCount = 0;
          if (btnLoadMore) btnLoadMore.hidden = true;

          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      }
    })();
  </script>
</body>
</html>

     
